2017/12/15
# BR004744-作者修文需求
### 需求分析
<pre>
作者无法主动更新已上架的内容，只能通过质检驳回操作进行章节内容的更新，编辑工作效率低，操作流程长。

问题解读
1、上架的书，走的是章节抢先接口，作者更新章节，主站直接进行发布。
2、作者修改必须加入质检库，编辑进行驳回，作者才能修改。
3、现在、就是要简化流程。

作为<文学网>，通过<调用章节更新接口>，以便能够完成<对已上架的图书修改章节内容>。

要求：
1.自签约作者
2.作品状态，非质检状态

需要开发的任务
1.前台，要给作家进行章节修改
2.后台，新增章节更新审核模块，内容标记
3.审核驳回的通知
</pre>

<pre>
控制层：ChaptepConntoller
页面：admin.jsp
查询章节信息：ajax请求加载，"info.html"

1.针对于作者修改操作，立即发布还是原来的逻辑

SELECT t.is_verify  FROM booklist t 
为1是上架图书

</pre>

<pre>
工作内容：
1.点击作品操作或者投稿操作，然后点击章节管理，展示所有章节内容，默认加载最新一章
  1.1 章节异步加载的js代码修改
  1.2 判断作者语录，是否为空
2、作者查看是修改前还是修改后的内容，
   如果章节没审核通过，则展示BOOKCHAPTER_AUDIT 表中内容
3.上架章节审核，字数统计逻辑
章节修改后字数需要比修改前字数多，（跟最后审核通过章节字数比较 ，bookchapter 表中的CHAPTERNUMBER字段值）
</pre>

<pre>
页面细节：
1.左侧章节按卷默认全部展开		1   是否全部展开？全部展开
2.章节按序号，倒叙排序			1
3.章节驳回章节，增加展示图案	1
</pre>


### sql
<pre>
// 插入审核表
INSERT INTO BOOKCHAPTER_AUDIT (
  AUDIT_ID,
	CHAPTER_ID,
	BOOK_NAME,
	PEN_NAME,
	CHAPTER_NUMBER,
	CHAPTER_TITLE,
	CHAPTERREPOADDRESS,
	JOTTINGS,
	CHAPTER_WORDCOUNT,
	AUDIT_STATUS,
	AUDIT_FIRST_SUBMIT_TIME,
	AUDIT_LAST_SUBMIT_TIME,
	AUTHORID
)
VALUES
	(19,1937602298826625, '慢慢长夜', '偏执', 1, '章节名称xxx', 
'我是章节内容xxx____________我是章节内容xxx', '我是作者语录xxxx我是作者语录xxxx我是作者语录xxxx',
 6660, 0,(select sysdate from dual),(select sysdate from dual) , 20171213562486)

// 查询审核状态
SELECT
	AUDIT_STATUS
FROM
	BOOKCHAPTER_AUDIT
WHERE
	CHAPTER_ID = 1937616451861505;

// 插入审核驳回表
INSERT INTO "MIGUDATA"."BOOKCHAPTER_REJECT_RECODE" ("AUDIT_ID", "CHAPTER_ID", "BOOK_NAME", "CHAPTER_TITLE", "AUTHORID", "REJECT_REASON", "AUDITOR", "AUDIT_TIME", "ID_UPDATE", "BOOKID") VALUES ('1937611182613505', '1937602298826625', '慢慢长夜', '风平浪静', '15065716562455', '就是想驳回', NULL, TO_DATE('2017-12-20 00:00:00', 'SYYYY-MM-DD HH24:MI:SS'), NULL, '1936829066584577');
</pre>




### junit单元测试
<pre>
// 接口一：章节审批表插入
	BookchapterAuditVO chapter = new BookchapterAuditVO();
	chapter.setAuditId(IDGenerator.getID());
	chapter.setBookId(1936829066584577L);
	// 章节ID
	chapter.setChapterId(1937616451861505L);
	chapter.setBookName("慢慢长夜");
	chapter.setPenName("偏执");
	// 章节章号
	chapter.setChapterNumber(1);
	// 章节名称
	chapter.setChaptertitle("章节名称xxx");
	// 章节内容
	chapter.setChapterrepoaddress("我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________");
	// 作者语录
	chapter.setJottings("我是作者语录xxxx我是作者语录xxxx我是作者语录xxxx");
	// 章节字数
	chapter.setChapNumber(6660);
	chapter.setAuditStatus((short)0);
	chapter.setCreate_au(new Date());
	chapter.setUpdate_au(new Date());
	chapter.setAuthorId(20171213562486L);
	
	bookchapterAuditService.insert(chapter);

// 接口二：图书上架
	if(bookService.isOnShelf(bookId)) {
	    System.out.println("图书上已上架");
	} else {
	    System.out.println("图书未上架");
	}
	Long chapterId = 1937058625037950L;

// 接口三：章节审核查询
	BookchapterAuditVO BookchapterAuditVO = bookchapterAuditService.getById(chapterId);
	System.out.println(BookchapterAuditVO);

// 接口四：是否为审核中状态
	boolean isAuditting = bookchapterAuditService.isAuditting(1936829066586497L);
            System.out.println(isAuditting);
// 接口五：章节更新
	BookchapterAuditVO chapter = new BookchapterAuditVO();
            // 章节ID
            chapter.setChapterId(1937616451861505L);
            // 章节章号
            // 章节名称
            chapter.setChaptertitle("修改章节名称xxx");
            // 章节内容
            chapter.setChapterrepoaddress("修改我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________我是章节内容xxx____________");
            // 作者语录
            chapter.setJottings("修改我是作者语录xxxx我是作者语录xxxx我是作者语录xxxx");
            // 章节字数
            chapter.setChapNumber(660);
            chapter.setUpdate_au(new Date());
            bookchapterAuditService.update(chapter);
</pre>

<pre>
关于状态，
1.bookchapter.ISPASS      章节状态      状态 0:未审核、1:通过，2：不通过
2.booklist.CONTRIBUTESTATUS 投稿审核状态 状态：0：未分配；1：审核中；2：审核通过；3：审核不通过
3.booklist.IS_VERIFY   图书上架状态      状态 0:未审批、1：审批通过，2：审批不通过、3:图书已下架        
</pre>

<pre>
确认下
1.投稿审核通过之前，不管驻场、专属的图书，都是可以修改的
2.投稿通过之后
    1)UGC图书的话————更新bookchapter，调接口
	2)专属图书，非上架状态，改bookchapter表，ispass改为0，就是可以修改
    3)上架状态，判断章节更新审核表
       a)状态值为空，或者已通过状态，就去插入表。
       b)状态值为审核中或者审核驳回状态，就更新表 
</pre>

<pre>			
1.UGC图书，不能进行驳回操作
  根据渠道图书ID是否存在，进行是否同步驻站，抢先章节接口
2.专属图书
  2.1投稿审核通过之前，修改的就是bookchapter表，驳回的修改之后状态为审核中
   a.原来的投稿前的话，有什么保存作者语录、修改保存、再次发布按钮啊，现在进行统一为一个提交按钮。
   b.现在的话，驳回的修改之后，状态就是为审核中。
 2.2投稿审核之后（本次开发目的），
  已通过状态
  a.原来的话，章节标题、章节内容，是不能进行修改的，可以修改作者语录
  b.现在的话，章节标题、章节内容，可以修改，走章节更新审批流程（新），{作者语录修改的话，随时可以修改，不走审批流程}
</pre>


<pre>
哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈
</pre>

显示的时候
	1.获取的是last_submit最新的数据
修改更新的时候
	
2017/12/27 
# BR004867-站内信需求
<pre>
消息展示改造 消息定时发布 公告改造： 陈季星
系统消息发布：    邹政凯
私信：  李炜  庞军
</pre>
### 需求分析
<pre>
12/29/2017 11:13:05 AM 
1.就是首页、作家专区、站内信
都保留，但是点击作家专区和站内信，跳转到登录页
</pre>

<pre>
公告、系统消息、私信是分开的。
1.换编辑器
2.做全局配置，发送邮件的，发送短信的
3.消息通知的
4.增加【站内信管理】一级文件夹，下面增加【公告管理】（仅针对有权限的人员展示）、【私信发送】、【私信列表】
5.@联想的模糊查询
</pre>

* [ueditor](http://localhost:8118/wenxue/ueditor/show.htm)

<pre>
1.创建MESSAGE
2.创建ANNOUNCEMENT_READ_RECODE
3.创建NOTIFY_MESSAGE
4.创建NOTIFY_MESSAGE
5.创建NOTIFY_MESSAGE



SELECT * FROM AUTHOR WHERE USERID =1938283822200577

chapterId 


SELECT count(1)
          FROM NOTIFY_MESSAGE T
         WHERE AUTHOR_ID = 1
 UNION ALL
 SELECT count(1)
          FROM MESSAGE_RECIVE T, MESSAGE T2
         WHERE T.RECEIVER = 1
           AND T.MESSAGE_ID = T2.ID
           AND T2.MESSAGE_STATUS = 3

</pre>

       

### 梳理站内信展示页面
<pre>
消息是否已读;0：未读  1：已读

一、私信
二、系统消息类型
	1：作者审核   
	2：作品审核
	3：作品信息审核
	4：章节审核
	5：章节内容修改审核
	6：完结申请审核
	7：推荐奖申请通知-针对被推荐人
	8：推荐奖申请通知-针对推荐人

	9：保底到期 

UPDATE MESSAGE_RECIVE SET READ_FLAG = 0

UPDATE NOTIFY_MESSAGE SET READ_FLAG = 0

// 查询公告
SELECT
	T.ID,
	T.TITLE,
	T.CONTENT,
	T.ADDTIME,
  T2.READ_TIME,
  T2.AUTHOR_ID
FROM
	ANNOUNCEMENT T LEFT OUTER JOIN
  ANNOUNCEMENT_READ_RECODE T2
ON
  T.ID = T2.ANNOUNCEMENT_ID
and T2.AUTHOR_ID = 456789
WHERE
	ISDELETE = 0
AND ADDTIME <= SYSDATE
ORDER BY
	ADDTIME DESC
</pre>

展示章节树
<pre>
// 加载卷 getRollListAndChapterListByBookId
 SELECT
            ID ROLLID,
            ROLL_NAME,
            ROLL_INTRO,
            STATUS
        FROM BOOKROLL
        WHERE BOOK_ID = 1938496608867841
        ORDER BY ID DESC 

// 加载卷所属章节 getBookchapterListByRoolId
SELECT
            id,
            chaptertitle,
            ispass,
            ditchmessage
        FROM BOOKCHAPTER
        WHERE ROLLID = 1936829066586625 AND CHAPTER_NUMBER IS NOT NULL
        ORDER BY CHAPTER_NUMBER DESC
</pre>

rollID: 1939178726403713

1939259617972993